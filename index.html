<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Multiplayer platformer test</title>
	<script src="js/jquery.min.js"></script>
  <script src="js/socket.io.js"></script>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
				#game {
					display: inline;
					float: left;
					width: 800px;
				}
				#score {
					display:inline;
					float: left;
					padding: 20px;
				}
    </style>
</head>
<body>

	<div id="game"></div>

	<div id="score">
		<table>
			<thead>
				<tr>
					<th>Player</th>
					<th>Kills</th>
					<th>Deaths</th>
				</tr>
			</thead>
			<tbody id="scoreboard"></tbody>
		</table>
	</div>

<script type="text/javascript">

var baseUrl = document.location.hostname == "localhost"?"http://localhost:1346":'http://52.31.77.24:1346';

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'game', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
		// game.load.tilemap('tilemap', 'assets/map.json', null, Phaser.Tilemap.TILED_JSON);
    // game.load.image('tiles', 'assets/tiles_spritesheet.png');

		game.stage.disableVisibilityChange = true;

}

var myUsername = '';
var players = {};
var names = {};
var playerActions = {};
var platforms;
var cursors;
var spawnPoint;

function addPlayer(username, center, velocity, actions, kills, deaths, tint) {
	console.log('add player called', username);
	// The player and its settings
	var x = center?center.x:spawnPoint.x;
	var y = center?center.y:spawnPoint.y;
	var newPlayer = game.add.sprite(x, y, 'dude');

	//  We need to enable physics on the player
	game.physics.arcade.enable(newPlayer);

	//  Player physics properties. Give the little guy a slight bounce.
	newPlayer.body.bounce.y = 0.2;
	newPlayer.body.gravity.y = 800;
	newPlayer.body.collideWorldBounds = false;

	if(velocity) newPlayer.body.velocity = velocity;

	newPlayer.kills = kills?kills:0;
	newPlayer.deaths = deaths?deaths:0;

	if(tint) newPlayer.tint = tint;

	//  Our two animations, walking left and right.
	newPlayer.animations.add('left', [0, 1, 2, 3], 10, true);
	newPlayer.animations.add('right', [5, 6, 7, 8], 10, true);

	if(!username) username = myUsername;

	newPlayer.name = username;

	players[username] = newPlayer;

	$('#scoreboard').append('<tr><td class="username">'+username+'</td><td class="kills">'+newPlayer.kills+'</td><td class="deaths">'+newPlayer.deaths+'</td></tr>');

	names[username] = game.add.text(newPlayer.x-10, newPlayer.y-10, username, 8);
	names[username].fontSize = 10;

	if(actions) {
		playerActions[username] = actions;
	} else {
		playerActions[username] = {}
	}
}

function updatePlayer(username) {

	if(!username) username = myUsername;

	var player = players[username];

	//  Reset the players velocity (movement)
	player.body.velocity.x = 0;

	if (playerActions[username]['left'])
	{
			//  Move to the left
			player.body.velocity.x = -150;

			player.animations.play('left');
	}
	else if (playerActions[username]['right'])
	{
			//  Move to the right
			player.body.velocity.x = 150;

			player.animations.play('right');
	}
	else
	{
			if (playerActions[username]['down']) {
				if(player.body.touching.down/* && player.y < 480*/) player.y += 5;
			}

			//  Stand still
			player.animations.stop();

			player.frame = 4;
	}

	//  Allow the player to jump if they are touching the ground.
	if (playerActions[username]['up'] && player.body.touching.down)
	{
			player.body.velocity.y = -600;
	}
}

function create() {

		var username = prompt("select a username");

		$.post(baseUrl+'/generateToken', {username:username}, function(response) {

			socket = io.connect(baseUrl);

			socket.on('connect', function(data) {
				console.log('joining room with '+response.token);
				socket.emit('authenticate', {token:response.token});
				socket.on('authenticated', function(response) {
					console.log('authentication', response);
					socket.emit('phaserJoin', 'phaser');
					myUsername = response.username;
					var tint = Math.random() * 0xffffff;
					var startPosition = {
						x: Math.random()* 800,
						y: 0
					}
					addPlayer(myUsername, startPosition);
					socket.emit('phaserSpawn', startPosition);
					socket.on('phaserJoin', function(data) {
						console.log('player joined '+data.username);
						//addPlayer(data.username);
						socket.emit('phaserMe', {
							to: data.username,
							username: myUsername,
							center: players[myUsername].position,
							velocity: players[myUsername].body.velocity,
							kills: players[myUsername].kills,
							deaths: players[myUsername].deaths,
							tint: tint
						});
					});
					socket.on('phaserMe', function(data) {
						console.log('previous player '+data.username);
						addPlayer(data.username, data.center, data.velocity, false, data.kills, data.deaths);
					})
					socket.on('phaserSpawn', function(data) {
						if(players[data.player.username]) respawnPlayer(players[data.player.username], data.position);
						else addPlayer(data.player.username, data.position);
					})
					socket.on('phaserAction', function(data) {
						var player = players[data.player.username];
						playerActions[data.player.username][data.action.action] = data.action.value;
						//player.body.moves = false;
						player.x = data.action.position.x;
						player.y = data.action.position.y;
						player.body.velocity.y = data.action.velocity.y;
						player.body.velocity.y = data.action.velocity.y;
						//player.body.moves = true;
					})
					socket.on('userDisconnected', function(data) {
						console.log('disconnection', data);
						$( ".username:contains('"+data.user+"')" ).parent().remove();
						if(names[data.user]) {
							names[data.user].destroy();
							delete names[data.user];
						}
						if(players[data.user]) {
							players[data.user].kill();
							delete players[data.user];
						}
					})
				});

				socket.on('disconnect', function() {
					alert('Nope. Try again.')
				})

			});

		});

		spawnPoint = {x:32, y:game.world.height-200}

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');

		//groundLayer.resizeWorld();

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the ground.
    var ground = platforms.create(0, game.world.height - 32, 'ground');

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    ground.scale.setTo(4, 2);

    //  This stops it from falling away when you jump on it
    ground.body.immovable = true;

    //  Now let's create two ledges
    var ledge = platforms.create(200, 420, 'ground');
    ledge.body.immovable = true;
		ledge.body.checkCollision.down = false;

    ledge = platforms.create(-150, 300, 'ground');
    ledge.body.immovable = true;
		ledge.body.checkCollision.down = false;

		ledge = platforms.create(450, 200, 'ground');
    ledge.body.immovable = true;
		ledge.body.checkCollision.down = false;

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

		cursors.left.onUp.add(function() {
			playerActions[myUsername]['left'] = false;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'left',
				value: false
			})
		})

		cursors.left.onDown.add(function() {
			playerActions[myUsername]['left'] = true;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'left',
				value: true
			})
		})

		cursors.right.onUp.add(function() {
			playerActions[myUsername]['right'] = false;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'right',
				value: false
			})
		})

		cursors.right.onDown.add(function() {
			playerActions[myUsername]['right'] = true;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'right',
				value: true
			})
		})

		cursors.up.onUp.add(function() {
			playerActions[myUsername]['up'] = false;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'up',
				value: false
			})
		})

		cursors.up.onDown.add(function() {
			playerActions[myUsername]['up'] = true;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'up',
				value: true
			})
		})

		cursors.down.onUp.add(function() {
			playerActions[myUsername]['down'] = false;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'down',
				value: false
			})
		})

		cursors.down.onDown.add(function() {
			playerActions[myUsername]['down'] = true;
			socket.emit('phaserAction', {
				position: players[myUsername].position,
				velocity: players[myUsername].body.velocity,
				action: 'down',
				value: true
			})
		})

}

function update() {

    //  Collide the player and the stars with the platforms
		for(username in players) {
			game.physics.arcade.collide(players[username], platforms);
			game.world.wrap(players[username], 0, true);
			names[username].x = players[username].x-names[username].getBounds().width/2+16;
			names[username].y = players[username].y-10;
			for(username2 in players) {
				if(username != username2) game.physics.arcade.collide(players[username], players[username2], collisionHandler);
			}
			updatePlayer(username);
		}

}

function collisionHandler(obj1, obj2) {
	//do something
	if(obj1.body.touching.down && obj2.body.touching.up) {
		killHandler(obj1, obj2);
	} else if(obj2.body.touching.down && obj1.body.touching.up) {
		killHandler(obj2, obj1);
	}
}

function killHandler(killer, killed) {
	//console.log(killer.name+' killed '+killed.name);
	if(killed.unkillable) return;
	killed.unkillable = true;
	setTimeout(function(){killed.unkillable=false}, 2000);
	if(killed.name == myUsername) {
		var data = {
			x: Math.random() * 800,
			y: 0,
			killer: killer.name
		}
		socket.emit('phaserSpawn', data);
		respawnPlayer(players[myUsername], data);
	}
}

function respawnPlayer(player, data) {
	player.kill();
	player.x = data.x;
	player.y = data.y;
	player.revive();
	if(data.killer) {
		var killer = players[data.killer];
		player.deaths += 1;
		$( ".username:contains('"+player.name+"')" ).parent().find('.deaths').html(player.deaths);
		killer.kills += 1;
		$( ".username:contains('"+killer.name+"')" ).parent().find('.kills').html(killer.kills);
		killer.body.velocity.y = -600;
	}
}

</script>

</body>
</html>
